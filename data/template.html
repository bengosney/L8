<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
      <link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.5/cerulean/bootstrap.min.css" rel="stylesheet">
	<style>
	  button{outline: none !important;}
	</style>
	<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>
	<title>W8</title>
  </head>
  <body>
    <div class="container-fluid">
      <div ng-app="w8">
	<div ng-controller="DomainCtrl">
	  <div class="row">
	    <div class="col-sm-6">
	      <h1>W8 Error Listings</h1>
	    </div>
	  </div>
	  <div class="row">
	    <div id="domainList" class="col-lg-3">
	      <div class="panel panel-default">
		<div class="panel-heading">Domains</div>
		<table class="table table-hover table-striped">
		  <thead>
		    <tr>
		      <th>Domain</th>
		      <th>Errors</th>
		    </tr>
		  </thead>
		  <tbody>
		    <tr ng-repeat="domain in domains"  ng-class="{info: lastHost == domain.host}">
		      <td ng-click="getErrors(domain.host)">{{domain.host}}</td>
		      <td>{{domain.error_count}}</td>
		    </tr>
		  </tbody>
		</table>
	      </div>
	    </div>
	    <div id="errorList" class="col-lg-9">
	      <div class="panel panel-default">
		<div class="panel-heading">Errors</div>								
		<div class="panel-body">
		  <div class="btn-toolbar">
		    <div class="btn-group">
		      <button class="btn btn-default" type="button" ng-class="{active: selectedLevels.length == errorLevels.length}" ng-click="setLevelAll()">All</button>
		      <button ng-repeat="errorType in errorLevels" class="btn btn-default" type="button" ng-class="{active: selectedLevels.indexOf(errorType) != -1}" ng-click="setLevel(errorType)">{{errorType}}</button>
		    </div>
		    <div class="btn-group">
		      <button class="btn btn-default" type="button" ng-class="{active: refreshErrors == true}"  ng-click="toggleErrorRefresh()">Auto Refresh</button>
		      <button class="btn btn-default" type="button" ng-class="{disabled: lastHost == '' || refreshErrors == true}"  ng-click="getErrors(lastHost)">Refresh</button>
		      <button class="btn btn-default" type="button" ng-class="{active: groupErrors == true}"  ng-click="toggleGroupErrors()">Group Errors</button>
		    </div>
		    <form class="form-inline pull-right">
		      <div class="form-group">
			<div class="input-group">
			  <input id="search" type="text" class="form-control" ng-model="searchText" placeholder="Search errors..." />
			</div>
		      </div>
		    </form>
		  </div>
		</div>
		<table class="table table-hover table-striped">
		  <thead>
		    <tr>
		      <th>Level</th>
		      <th>Message</th>
		      <th ng-click="setSort('count')">Count <span class="glyphicon" ng-class="{'glyphicon-triangle-bottom': sortBy == '-count', 'glyphicon-triangle-top': sortBy == 'count'}"></span></th>
		      <th ng-click="setSort('time')">Time <span class="glyphicon" ng-class="{'glyphicon-triangle-bottom': sortBy == 'time', 'glyphicon-triangle-top': sortBy == '-time'}"></span></th>
		      <th>&nbsp;</th>
		    </tr>
		  </thead>
		  <tbody>
		    <tr ng-repeat="error in errors | filter:searchText | inArray:selectedLevels:'level' | orderBy: sortBy"  ng-click="selectedError = error.id">
		      <td class="p10">{{error.level}}</td>
		      <td>
			<pre>{{ error.message | limitTo : 125 : 0 }}</pre>
			<pre>{{ error.file }} : {{ error.line }}</pre>
		      </td>
		      <td class="p10">{{error.count}}</td>
		      <td class="p10">{{error.ptime}}</td>
		      <td><button href="#" ng-click="deleteError(error.id)" ng-class="{disabled: deleting[error.id] == true}" class="btn btn-default" type="button">Delete</button></td>
		    </tr>
		  </tbody>
		</table>
	      </div>
	    </div>
	  </div>
	</div>
      </div>
      <script>
       angular.module('inArray', []).filter('inArray', function($filter){
	 return function(list, arrayFilter, element){
	   if(arrayFilter){
	     return $filter("filter")(list, function(listItem){
	       return arrayFilter.indexOf(listItem[element]) != -1;
	     });
	   }
	 };
       }); 
       
       var app = angular.module('w8', ['inArray']);

       angular.module('w8').filter('inArray', function($filter){
	 return function(list, arrayFilter, element){
	   if(arrayFilter){
	     return $filter("filter")(list, function(listItem){
	       if(arrayFilter.length > 0) {
		 return arrayFilter.indexOf(listItem[element]) != -1;
	       } else {
		 return false;
	       }
	     });
	   }
	 };
       });

       app.controller('DomainCtrl', function($scope, $http) {
	 $scope.domains = [];
	 $scope.errors = [];
	 $scope.errorLevels = [];
	 $scope.errorLevel = '';
	 $scope.selectedLevels = [];
	 $scope.refreshErrors = true;
	 $scope.lastHost = '';
	 $scope.sortBy = '-time';
	 $scope.groupErrors = true;
	 $scope.selectedError = '';
	 $scope.deleting = [];
	 var domainHash = '';
	 var errorHash = '';

	 $http.get('/api/v1.0/levels/').success(function(data) {
	   $scope.errorLevels = data.levels;
	   $scope.selectedLevels = $scope.errorLevels.slice();
	 });

	 function getDomains() {
	   $http.get('/api/v1.0/domain/list/').success(function(data) {
	     if(domainHash != data.hash) {
	       domainHash = data.hash;
	       $scope.domains = data.domains;
	     }
	   });
	 }

	 $scope.getErrors = function(host) {
	   $scope.lastHost = host;
	   if($scope.groupErrors) {
	     url = '/api/v1.0/domain/' + host + '/errors/1/';
	   } else {
	     url = '/api/v1.0/domain/' + host + '/errors/0/';
	   }
	   $http.get(url).success(function(data) {
	     if(errorHash != data.hash) {
	       errorHash = data.hash
	       $scope.errors = data.errors;
	     }
	   });
	 }

	 $scope.deleteError = function(id) {
	   $scope.deleting[id] = true;
	   if ($scope.groupErrors) {
	     url = '/api/v1.0/delete/group/' + id + '/';
	   } else {
	     url = '/api/v1.0/delete/' + id + '/';
	   }
	   console.log(url);
	   $http.get(url).success(function(data) {
	     $scope.getErrors($scope.lastHost);
	     getDomains();
	     $scope.deleting[id] = false;
	   });
	 }

	 function getAutoErrors() {
	   if($scope.refreshErrors && $scope.lastHost != '') {
	     $scope.getErrors($scope.lastHost);
	   }
	 }

	 $scope.setLevel = function(level) {
	   $scope.errorLevel = level;
	   index = $scope.selectedLevels.indexOf(level);
	   if(index != -1) {
	     $scope.selectedLevels.splice(index, 1);
	   } else {
	     $scope.selectedLevels.push(level);
	   }
	   console.log($scope.selectedLevels);
	 };

	 $scope.setLevelAll = function() {
	   $scope.selectedLevels = $scope.errorLevels.slice();
	 }
	 $scope.setLevelNone = function() {
	   $scope.selectedLevels = [];
	 }

	 $scope.toggleErrorRefresh = function() {
	   $scope.refreshErrors = !$scope.refreshErrors;
	 }

	 $scope.toggleGroupErrors = function() {
	   $scope.groupErrors = !$scope.groupErrors;
	   getAutoErrors();
	 }

	 $scope.setSort = function(sort) {
	   if($scope.sortBy == sort) {
	     $scope.sortBy = '-' + sort;
	   } else {
	     $scope.sortBy = sort;
	   }
	   console.log('set the sort to: ' + sort);
	 }

	 getDomains();
	 setInterval(function() {getDomains();getAutoErrors();}, 5000);
       });
      </script>
  </body>
</html>
