<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
		<link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.5/lumen/bootstrap.min.css" rel="stylesheet">
		<style>button{outline: none !important;}</style>
		<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>
		<title>W8</title>
	</head>
	<body>
		<div class="container-fluid">
			<div ng-app="w8">
				<div ng-controller="DomainCtrl">
					<div class="row">
						<div class="col-sm-6">
							<h1>W8 Error Listings</h1>
						</div>
						<div class="col-sm-6">
							<div class="pull-right form-group">
								<label for="search">Search</label>
								<input id="search" type="text" ng-model="searchText" />
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-lg-offset-4 col-lg-6">
							<span>
								<button class="btn btn-default" type="button" ng-click="setLevel('')">All</button>
							</span>
							<span ng-repeat="errorType in errorLevels">
								<button class="btn btn-default" type="button" ng-class="{active: errorLevel == errorType}" ng-click="setLevel(errorType)">{{errorType}}</button>
							</span>
						</div>
						<div class="col-lg-2">
							<button class="btn btn-default" type="button" ng-class="{active: refreshErrors == true}"  ng-click="toggleErrorRefresh()">Auto Refresh Errors</button>
						</div>
					</div>
					<div class="row">
						<div id="domainList" class="col-lg-4">
							<table class="table table-hover table-striped">
								<tr>
									<th>Domain</th>
									<th>Errors</th>
								</tr>
								<tr ng-repeat="domain in domains">
									<td ng-click="getErrors(domain.host)">{{domain.host}}</td>
									<td>{{domain.error_count}}</td>
								</tr>
							</table>
						</div>
						<div id="errorList" class="col-lg-8">
							<table class="table table-hover table-striped">
								<tr>
									<th>Level</th>
									<th>Message</th>
									<th>Count</th>
									<th>Time</th>
								</tr>
								<tr ng-repeat="error in errors | filter:searchText | filter:{level: errorLevel}">
									<td>{{error.level}}</td>
									<td>{{error.message}}</td>
									<td>{{error.count}}</td>
									<td>{{error.ptime}}</td>
								</tr>
							</table>
						</div>
					</div>
				</div>
			</div>
			<script>
			var app = angular.module('w8', []);

			app.controller('DomainCtrl', function($scope, $http) {
				$scope.domains = [];
				$scope.errors = [];
				$scope.errorLevels = [];
				$scope.errorLevel = '';
				$scope.refreshErrors = false;
				$scope.lastHost = '';
				var domainHash = '';
				var errorHash = '';

				$http.get('/api/v1.0/levels/').success(function(data) {
					$scope.errorLevels = data.levels;
				});

				function getDomains() {
					$http.get('/api/v1.0/domain/list/').success(function(data) {
						if(domainHash != data.hash) {
							domainHash = data.hash;
							$scope.domains = data.domains;
						}
					});
				}

				$scope.getErrors = function(host) {
					$scope.lastHost = host;
					$http.get('/api/v1.0/domain/' + host + '/errors/').success(function(data) {
						if(errorHash != data.hash) {
							errorHash = data.hash
							$scope.errors = data.errors;
						}
					});
				}

				function getAutoErrors() {
					if($scope.refreshErrors && $scope.lastHost != '') {
						$scope.getErrors($scope.lastHost);
					}
				}

				$scope.setLevel = function(level) {
					$scope.errorLevel = level;
				};

				$scope.toggleErrorRefresh = function() {
					$scope.refreshErrors = !$scope.refreshErrors;
				}

				getDomains();
				setInterval(function() {getDomains();getAutoErrors();}, 1000);
			});
			</script>
	</body>
</html>
